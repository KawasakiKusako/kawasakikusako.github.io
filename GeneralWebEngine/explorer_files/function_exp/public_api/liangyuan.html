<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据仓库与数据挖掘在线答题</title>
    <!-- 引入 Tailwind CSS 进行样式美化和响应式布局 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义样式 */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .quiz-container { max-width: 900px; margin: auto; min-height: 100vh; }
        .fill-in-input {
            display: inline-block; width: auto; min-width: 100px; margin: 0 4px; padding: 4px 8px;
            border: 2px dashed #6b7280; border-radius: 6px; background-color: #fff; text-align: center;
            font-weight: 500; transition: all 0.2s ease-in-out;
        }
        .fill-in-input:focus { border-color: #4f46e5; outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        .correct-answer { background-color: #d1fae5; border-color: #10b981; color: #065f46; }
        .incorrect-answer { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .option-item { cursor: pointer; transition: background-color 0.15s; }
        .option-item:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="quiz-container">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 tracking-tight">数据仓库与数据挖掘题库练习</h1>
            <p class="mt-2 text-lg text-gray-500">魔丸拟合-在线练习魔丸题库</p>
        </header>

        <main class="bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
            <!-- 模式和题型选择区域 -->
            <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-lg font-semibold text-gray-700 mb-3">选择练习模式：</p>
                
                <!-- 模式选择 -->
                <div class="flex flex-wrap gap-4 mb-4" id="mode-selection">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="practiceMode" value="random" checked onchange="handleModeChange(this.value)" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-sm font-medium text-gray-700">随机练题 (所有题型)</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="practiceMode" value="sequential" onchange="handleModeChange(this.value)" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-sm font-medium text-gray-700">顺序练题 (按题型)</span>
                    </label>
                </div>

                <!-- 题型选择 (仅在顺序模式下显示) -->
                <div id="type-selection" class="hidden">
                    <label for="question-type" class="block text-sm font-medium text-gray-700 mb-1">选择题型：</label>
                    <select id="question-type" onchange="resetSequentialMode()" class="mt-1 block w-full sm:w-1/2 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        <!-- 选项将由 JS 加载后动态添加 -->
                    </select>
                </div>
            </div>


            <!-- 题目区域 -->
            <div id="question-area" class="min-h-[150px]">
                <p id="loading-message" class="text-center text-xl font-semibold text-indigo-600">正在加载题库文件...</p>
            </div>

            <!-- 操作按钮区域 -->
            <div class="mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row justify-between space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="check-btn" onclick="checkAnswer()" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:bg-indigo-400" disabled>
                    检查答案
                </button>
                <button id="next-btn" onclick="loadNextQuestion()" class="w-full sm:w-auto px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-150 ease-in-out disabled:bg-gray-400" disabled>
                    下一题
                </button>
            </div>

            <!-- 结果反馈区域 -->
            <div id="result-area" class="mt-6 p-4 rounded-lg hidden">
                <p id="result-text" class="text-lg font-bold"></p>
                <div id="correct-answer-display" class="mt-2 text-sm text-gray-700"></div>
            </div>
            
        </main>

        <div>
            <p>       </p>    
            <p id="result-text" class="mt-2 text-lg text-gray-500">Github @ Kawasaki Kusako</p>
        </div>
    </div>

    <script>
        let quizData = [];
        let currentQuestion = null;
        let questionIndex = 0;
        const BLANK_PLACEHOLDER = "_BLANK_";
        
        // 新增状态管理
        let currentMode = 'random'; // 'random' 或 'sequential'
        let typeIndexMap = {}; // 顺序模式下，记录每种题型当前的索引
        let availableTypes = []; // 已加载的题型列表

        // 文件路径配置
        const FILE_PATHS = [
            { type: 'fill_in_the_blank', path: 'static/tiankong.csv', headers: ['题号', '题目', '答案'], label: '填空题' },
            { type: 'multiple_choice', path: 'static/xuanze.csv', headers: ['题号', '题目', '选项A', '选项B', '选项C', '选项D', '答案'], label: '选择题' },
            { type: 'true_false', path: 'static/panduan.csv', headers: ['题号', '题目', '答案'], label: '判断题' }
        ];

        // DOM 元素
        const questionArea = document.getElementById('question-area');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const resultArea = document.getElementById('result-area');
        const resultText = document.getElementById('result-text');
        const correctAnswerDisplay = document.getElementById('correct-answer-display');
        const loadingMessage = document.getElementById('loading-message');
        const typeSelectionDiv = document.getElementById('type-selection');
        const questionTypeSelect = document.getElementById('question-type');


        /**
         * 简单 CSV 解析器：将 CSV 文本转换为对象数组。
         */
        function parseCSV(csvText, requiredHeaders) {
            const lines = csvText.trim().split('\n').map(line => line.trim()).filter(line => line.length > 0);
            if (lines.length <= 1) return [];

            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            if (!requiredHeaders.every(h => headers.includes(h))) {
                throw new Error(`CSV 文件表头不匹配。要求: ${requiredHeaders.join(', ')}`);
            }

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i];
                const values = currentLine.split(',').map(v => v.trim());
                if (values.length !== headers.length) {
                     console.warn(`行 ${i + 1} 列数不匹配，跳过。`);
                     continue;
                }
                
                let item = {};
                headers.forEach((header, index) => {
                    item[header] = values[index];
                });

                data.push(item);
            }
            return data;
        }

        /**
         * 将原始解析的 CSV 数据转换为标准题库格式。
         */
        function normalizeQuizData(rawData, type) {
            return rawData.map((item, index) => {
                const standardizedItem = {
                    id: `${type}-${item['题号'] || index + 1}`,
                    type: type,
                    question: item['题目'],
                    answer: item['答案'].trim(),
                };

                if (type === 'fill_in_the_blank') {
                    standardizedItem.answer = standardizedItem.answer.split(';').map(a => a.trim()).filter(a => a.length > 0);
                } else if (type === 'multiple_choice') {
                    standardizedItem.options = [
                        `A. ${item['选项A']}`,
                        `B. ${item['选项B']}`,
                        `C. ${item['选项C']}`,
                        `D. ${item['选项D']}`
                    ];
                }
                return standardizedItem;
            }).filter(item => item.question && item.answer);
        }

        /**
         * 初始化题型选择下拉菜单
         */
        function initializeTypeSelect() {
            questionTypeSelect.innerHTML = '';
            availableTypes.forEach(typeInfo => {
                const option = document.createElement('option');
                option.value = typeInfo.type;
                option.textContent = `${typeInfo.label} (${typeInfo.count} 题)`;
                questionTypeSelect.appendChild(option);
                // 初始化顺序索引
                typeIndexMap[typeInfo.type] = 0;
            });
            // 默认选中第一个题型，并加载题目
            if (availableTypes.length > 0) {
                 loadNextQuestion();
            }
        }
        
        /**
         * 从文件中加载所有题库数据。
         */
        async function loadAllQuizData() {
            try {
                const loadPromises = FILE_PATHS.map(fileInfo =>
                    fetch(fileInfo.path)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`无法加载文件: ${fileInfo.path}.`);
                            }
                            return response.text();
                        })
                        .then(csvText => {
                            const rawData = parseCSV(csvText, fileInfo.headers);
                            const normalizedData = normalizeQuizData(rawData, fileInfo.type);
                            // 记录有效题型及其数量
                            if (normalizedData.length > 0) {
                                availableTypes.push({
                                    type: fileInfo.type,
                                    label: fileInfo.label,
                                    count: normalizedData.length
                                });
                            }
                            return normalizedData;
                        })
                );

                const results = await Promise.all(loadPromises);
                quizData = results.flat(); 

                if (quizData.length === 0) {
                    throw new Error("所有文件中均未发现有效题目。");
                }
                
                loadingMessage.classList.add('hidden');
                initializeTypeSelect(); // 必须在加载数据后初始化题型选择
                
            } catch (error) {
                console.error("加载题库失败:", error);
                loadingMessage.textContent = `❌ 加载题库失败：${error.message}. 请确保文件路径正确且文件内容符合格式。`;
                checkBtn.disabled = true;
                nextBtn.disabled = true;
            }
        }

        /**
         * 处理模式切换
         */
        function handleModeChange(mode) {
            currentMode = mode;
            // 重置题号计数
            questionIndex = 0;
            // 重置所有题型的顺序索引
            availableTypes.forEach(typeInfo => {
                typeIndexMap[typeInfo.type] = 0;
            });
            
            if (mode === 'sequential') {
                typeSelectionDiv.classList.remove('hidden');
            } else {
                typeSelectionDiv.classList.add('hidden');
            }
            
            // 切换模式后，自动加载下一题
            loadNextQuestion();
        }

        /**
         * 顺序模式下题型改变，重置该题型的索引
         */
        function resetSequentialMode() {
            // 重置当前选中的题型索引
            const selectedType = questionTypeSelect.value;
            typeIndexMap[selectedType] = 0;
            questionIndex = 0;
            loadNextQuestion();
        }

        /**
         * 随机模式：从整个题库中随机选取。
         */
        function selectRandomQuestion() {
            if (quizData.length === 0) return null;
            const randomIndex = Math.floor(Math.random() * quizData.length);
            return quizData[randomIndex];
        }

        /**
         * 顺序模式：按题型和索引顺序选取。
         */
        function getSequentialQuestion() {
            const selectedType = questionTypeSelect.value;
            const filteredQuestions = quizData.filter(q => q.type === selectedType);

            if (filteredQuestions.length === 0) return null;

            const currentIndex = typeIndexMap[selectedType];
            
            if (currentIndex >= filteredQuestions.length) {
                // 已达到题库末尾，循环回到第一题
                typeIndexMap[selectedType] = 0;
                questionIndex = 0; // 重置题号
                return getSequentialQuestion(); // 递归调用以加载第一题
            }

            const questionToLoad = filteredQuestions[currentIndex];
            // 准备加载下一题时，索引才自增
            typeIndexMap[selectedType] = currentIndex + 1; 

            return questionToLoad;
        }

        /**
         * 获取题型对应的中文名称
         */
        function getQuestionTypeLabel(type) {
            const typeInfo = FILE_PATHS.find(f => f.type === type);
            return typeInfo ? typeInfo.label : '未知题型';
        }

        /**
         * 渲染当前问题到页面上。
         */
        function renderQuestion(question) {
            currentQuestion = question;
            resultArea.classList.add('hidden');
            checkBtn.disabled = false;
            nextBtn.disabled = true;
            questionIndex++;

            const typeLabel = getQuestionTypeLabel(question.type);
            let questionHtml = `<div class="text-xl font-medium text-gray-700 leading-relaxed mb-4">${question.question}</div>`;
            
            let currentQuestionNumberDisplay;
            if (currentMode === 'sequential') {
                const selectedType = questionTypeSelect.value;
                const filteredQuestions = quizData.filter(q => q.type === selectedType);
                const currentSequentialIndex = typeIndexMap[selectedType] > 0 ? typeIndexMap[selectedType] : filteredQuestions.length; // 如果 index=0 表示从最后一题循环回来，显示总数
                currentQuestionNumberDisplay = `(${typeLabel}) 第 ${currentSequentialIndex}/${filteredQuestions.length} 题`;
            } else {
                currentQuestionNumberDisplay = `(随机 ${typeLabel}) 第 ${questionIndex} 题`;
            }

            // 根据题型渲染不同的输入或选择控件
            switch (question.type) {
                case 'fill_in_the_blank':
                    questionHtml = `<div class="text-xl font-medium text-gray-700 leading-relaxed">`;
                    const parts = question.question.split(BLANK_PLACEHOLDER);
                    
                    parts.forEach((part, index) => {
                        questionHtml += part.trim();
                        if (index < question.answer.length) { 
                            questionHtml += `<input type="text" data-blank-index="${index}" placeholder="请填写" class="fill-in-input focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">`;
                        }
                    });
                    questionHtml += `</div>`;
                    break;

                case 'multiple_choice':
                    questionHtml += `<div class="mt-4 space-y-3">`;
                    question.options.forEach((option) => {
                        const optionValue = option.charAt(0); 
                        questionHtml += `
                            <label class="flex items-center p-3 border border-gray-200 rounded-lg option-item">
                                <input type="radio" name="choice" value="${optionValue}" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500">
                                <span class="ml-3 text-base text-gray-800">${option}</span>
                            </label>
                        `;
                    });
                    questionHtml += `</div>`;
                    break;
                
                case 'true_false':
                    questionHtml += `<div class="mt-4 flex space-x-6">`;
                    const tfOptions = [{ label: '正确 (True)', value: 'True' }, { label: '错误 (False)', value: 'False' }];
                    tfOptions.forEach(option => {
                        questionHtml += `
                            <label class="flex items-center p-3 border border-gray-200 rounded-lg option-item min-w-[150px]">
                                <input type="radio" name="choice" value="${option.value}" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500">
                                <span class="ml-3 text-base text-gray-800">${option.label}</span>
                            </label>
                        `;
                    });
                    questionHtml += `</div>`;
                    break;
            }

            // 更新显示区域
            questionArea.innerHTML = `
                <p class="text-sm text-indigo-600 mb-2">${currentQuestionNumberDisplay}</p>
                ${questionHtml}
            `;
        }

        /**
         * 检查用户的答案是否正确。
         */
        function checkAnswer() {
            if (!currentQuestion) return;
            
            let allCorrect = true;
            let userAnswerDisplay = '';

            // ... (检查答案逻辑保持不变，因为它与模式无关)
            switch (currentQuestion.type) {
                case 'fill_in_the_blank':
                    const inputs = questionArea.querySelectorAll('input[type="text"]');
                    const correctAnswers = currentQuestion.answer;
                    const userAnswers = [];

                    inputs.forEach((input, index) => {
                        const userAnswer = input.value.trim();
                        const correctAnswer = correctAnswers[index].trim();
                        userAnswers.push(userAnswer);
                        const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();

                        if (isCorrect) {
                            input.classList.add('correct-answer');
                        } else {
                            input.classList.add('incorrect-answer');
                            allCorrect = false;
                        }
                        input.disabled = true;
                    });

                    userAnswerDisplay = `
                        <p class="font-semibold text-gray-800">正确答案：</p>
                        <ul class="list-disc list-inside mt-1 space-y-1">
                            ${correctAnswers.map((ans, i) => 
                                `<li class="${userAnswers[i].toLowerCase() === ans.toLowerCase() ? 'text-green-700' : 'text-red-600'}">
                                    填空 ${i + 1}: ${ans} (您的答案: ${userAnswers[i] || '未作答'})
                                </li>`
                            ).join('')}
                        </ul>
                    `;
                    break;

                case 'multiple_choice':
                case 'true_false':
                    const selectedInput = questionArea.querySelector('input[name="choice"]:checked');
                    const correctAnswerMC = String(currentQuestion.answer).trim();
                    const selectedValue = selectedInput ? selectedInput.value : '';
                    const selectedLabel = selectedInput ? selectedValue : '未作答';
                    
                    const allOptions = questionArea.querySelectorAll('input[name="choice"]');
                    allOptions.forEach(input => {
                        input.disabled = true;
                        const label = input.closest('label');
                        if (input.value === correctAnswerMC) {
                            label.classList.add('correct-answer', 'border-green-500');
                        } else if (input.checked && input.value !== correctAnswerMC) {
                            label.classList.add('incorrect-answer', 'border-red-500');
                        }
                    });

                    if (!selectedInput || selectedValue !== correctAnswerMC) {
                        allCorrect = false;
                    }
                    
                    const answerText = currentQuestion.type === 'multiple_choice' ? 
                                       currentQuestion.options.find(opt => opt.startsWith(correctAnswerMC)) || correctAnswerMC : 
                                       correctAnswerMC;

                    userAnswerDisplay = `
                        <p class="font-semibold text-gray-800">正确答案：<span class="text-green-700 font-normal">${answerText}</span></p>
                        <p class="font-semibold text-gray-800">您的选择：<span class="${allCorrect ? 'text-green-700' : 'text-red-600'} font-normal">${selectedLabel}</span></p>
                    `;
                    break;
            }

            // --- 通用结果反馈 ---
            resultArea.classList.remove('hidden');
            checkBtn.disabled = true;
            nextBtn.disabled = false;

            if (allCorrect) {
                resultArea.className = 'mt-6 p-4 rounded-lg bg-green-100 border border-green-500';
                resultText.textContent = '✅ 恭喜！回答完全正确。';
                resultText.classList.remove('text-red-600');
                resultText.classList.add('text-green-700');
                correctAnswerDisplay.innerHTML = '';
            } else {
                resultArea.className = 'mt-6 p-4 rounded-lg bg-red-100 border border-red-500';
                resultText.textContent = '❌ 很遗憾，回答不正确。';
                resultText.classList.remove('text-green-700');
                resultText.classList.add('text-red-600');
                correctAnswerDisplay.innerHTML = userAnswerDisplay;
            }
        }

        /**
         * 根据当前模式加载下一道问题。
         */
        function loadNextQuestion() {
             if (quizData.length === 0) {
                 questionArea.innerHTML = '<p class="text-center text-xl text-red-600">题库为空！请检查 CSV 文件是否正确加载。</p>';
                 checkBtn.disabled = true;
                 nextBtn.disabled = true;
                 return;
             }
             
            let nextQuestion = null;
            if (currentMode === 'random') {
                nextQuestion = selectRandomQuestion();
            } else {
                nextQuestion = getSequentialQuestion();
            }

            if (nextQuestion) {
                renderQuestion(nextQuestion);
            } else {
                let endMessage = '';
                if (currentMode === 'sequential') {
                     // 顺序模式下，如果没有下一题，说明该题型已循环一圈
                     endMessage = `当前题型已练习一轮，将从第一题重新开始。`;
                } else {
                     endMessage = '题库加载失败或已清空。';
                }
                
                questionArea.innerHTML = `<p class="text-center text-xl text-gray-500">${endMessage}</p>`;
                checkBtn.disabled = true;
                nextBtn.disabled = false; // 允许用户点击下一题重新开始循环
            }
        }
        
        // 页面加载后立即尝试加载题库
        window.onload = function() {
            loadAllQuizData(); 
        };
    </script>
</body>
</html>
